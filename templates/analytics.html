{% extends "layout.html" %}

{% block title %}Data Analysis - Badminton MASTER{% endblock %}
{% block page_title %}Badminton MASTER{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<style>
  /* Fix for chart container heights */
  .chart-container {
    height: 200px;
    position: relative;
  }

  /* Style for empty chart placeholders */
  .empty-chart-placeholder {
    height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f9fafb;
    border-radius: 0.375rem;
  }

  .empty-chart-icon {
    text-align: center;
    color: #9ca3af;
  }
</style>
{% endblock %}

{% block content %}
<div class="mb-6">
  <h2 class="text-2xl font-semibold">üìä Data Analysis Dashboard</h2>
  <p class="text-gray-600 mt-1">View your badminton game statistics and trends</p>
</div>

<!-- Analysis navigation -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
  <a href="{{ url_for('analytics.overall_analysis') }}" class="bg-red-600 text-white p-4 rounded-lg shadow hover:bg-green-700 transition text-center">Overall Analysis</a>
  <a href="/analytics/head_to_head" class="bg-green-600 text-white p-4 rounded-lg shadow hover:bg-green-700 transition text-center">
    Matchup Analysis
  </a>
  <div class="relative">
    <select id="playerSelect" class="appearance-none bg-yellow-500 text-white p-4 rounded-lg shadow hover:bg-yellow-600 transition text-center w-full cursor-pointer">
      <option value="">Select Player to Analyze...</option>
      {% for player in players %}
        <option value="{{ player.id }}">{{ player.name }}</option>
      {% endfor %}
    </select>
  </div>
</div>

<!-- Statistics Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
  <div class="bg-white p-6 rounded shadow text-center">
    <p class="text-gray-500">Game Type Distribution</p>
    <div class="chart-container mt-4">
      {% if match_distribution and match_distribution.labels|length > 0 %}
        <canvas id="matchTypeChart"></canvas>
      {% else %}
        <div class="empty-chart-placeholder">
          <div class="empty-chart-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="3" y1="9" x2="21" y2="9"></line>
              <line x1="9" y1="21" x2="9" y2="9"></line>
            </svg>
            <p>No game type data available</p>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="bg-white p-6 rounded shadow text-center">
    <p class="text-gray-500">Top Player Win Rate</p>
    <div class="chart-container mt-4">
      {% if player_win_rates and player_win_rates.labels|length > 0 %}
        <canvas id="winRateChart"></canvas>
      {% else %}
        <div class="empty-chart-placeholder">
          <div class="empty-chart-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <p>No player win rate data available</p>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="bg-white p-6 rounded shadow text-center">
    <p class="text-gray-500">Number of matches per month</p>
    <div class="chart-container mt-4">
      {% if monthly_matches and monthly_matches.labels|length > 0 %}
        <canvas id="monthlyMatchChart"></canvas>
      {% else %}
        <div class="empty-chart-placeholder">
          <div class="empty-chart-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <p>No monthly match data available</p>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Tournament Analysis -->
<div class="bg-white rounded shadow p-6 mb-10">
  <h3 class="text-xl font-bold mb-4">üèÜ Tournament Analysis</h3>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <p class="text-gray-500 mb-2">Select a tournament to view detailed analysis</p>
      <select id="tournamentSelect" class="w-full p-2 border rounded">
        <option value="">Select tournament...</option>
        {% for tournament in tournaments %}
          <option value="{{ tournament.id }}">{{ tournament.name }} ({{ tournament.date }})</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <p class="text-gray-500 mb-2">Tournament statistics</p>
      <ul class="space-y-1 text-gray-600">
        <li>‚Ä¢ Total Tournaments: <span class="font-medium">{{ tournaments|length }}</span></li>
        <li>‚Ä¢ Total number of matches: <span class="font-medium" id="totalMatches">Calculating...</span></li>
        <li>‚Ä¢ Average number of matches per tournament: <span class="font-medium" id="avgMatchesPerTournament">Calculating...</span></li>
      </ul>
    </div>
  </div>
</div>

<!-- Player Comparison -->
<div class="bg-white rounded shadow p-6 mb-10">
  <h3 class="text-xl font-bold mb-4">üèÖ Player Comparison</h3>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
      <label class="block text-gray-500 mb-2">Player 1</label>
      <select id="player1Select" class="w-full p-2 border rounded">
        <option value="">Selecting Player...</option>
        {% for player in players %}
          <option value="{{ player.id }}">{{ player.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="block text-gray-500 mb-2">Player 2</label>
      <select id="player2Select" class="w-full p-2 border rounded">
        <option value="">Selecting Player...</option>
        {% for player in players %}
          <option value="{{ player.id }}">{{ player.name }}</option>
        {% endfor %}
      </select>
    </div>
  </div>
  <div class="mt-4">
    <button id="compareBtn" class="bg-blue-600 text-white px-4 py-2 rounded disabled:bg-gray-400" disabled>
      Compare players
    </button>
  </div>
</div>

<!-- Quick Access to Other Features -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
  <a href="/upload" class="bg-purple-600 text-white p-4 rounded-lg shadow hover:bg-purple-700 transition text-center">
    Upload Tournament Data
  </a>
  <a href="/input_form" class="bg-indigo-600 text-white p-4 rounded-lg shadow hover:bg-indigo-700 transition text-center">
    Add New Matches
  </a>
  <a href="/dashboard" class="bg-teal-600 text-white p-4 rounded-lg shadow hover:bg-teal-700 transition text-center">
    Return to Dashboard
  </a>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Game type distribution charts - only initialize if data exists
    {% if match_distribution and match_distribution.labels|length > 0 %}
      const matchTypeData = JSON.parse('{{ match_distribution|safe }}');
      const matchTypeCtx = document.getElementById('matchTypeChart').getContext('2d');
      const matchTypeChart = new Chart(matchTypeCtx, {
        type: 'doughnut',
        data: {
          labels: matchTypeData.labels,
          datasets: [{
            data: matchTypeData.data,
            backgroundColor: [
              '#4F46E5', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                boxWidth: 12
              }
            }
          }
        }
      });
    {% endif %}

    // Player Win Rate Chart - only initialize if data exists
    {% if player_win_rates and player_win_rates.labels|length > 0 %}
      const winRateData = JSON.parse('{{ player_win_rates|safe }}');
      const winRateCtx = document.getElementById('winRateChart').getContext('2d');
      const winRateChart = new Chart(winRateCtx, {
        type: 'bar',
        data: {
          labels: winRateData.labels,
          datasets: [{
            label: 'Win Rate (%)',
            data: winRateData.data,
            backgroundColor: '#3B82F6',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          }
        }
      });
    {% endif %}

    // Monthly Match Count Chart - only initialize if data exists
    {% if monthly_matches and monthly_matches.labels|length > 0 %}
      const monthlyData = JSON.parse('{{ monthly_matches|safe }}');
      const monthlyCtx = document.getElementById('monthlyMatchChart').getContext('2d');
      const monthlyChart = new Chart(monthlyCtx, {
        type: 'line',
        data: {
          labels: monthlyData.labels,
          datasets: [{
            label: 'Number of matches',
            data: monthlyData.data,
            borderColor: '#10B981',
            backgroundColor: 'rgba(16, 185, 129, 0.2)',
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
    {% endif %}

    // Calculate the total number of matches
    let totalMatches = 0;
    {% if match_distribution and match_distribution.data %}
      const matchDataArray = {{ match_distribution.data|safe }};
      if (Array.isArray(matchDataArray)) {
        matchDataArray.forEach(count => {
          totalMatches += count;
        });
      }
    {% endif %}
    document.getElementById('totalMatches').textContent = totalMatches;

    // Calculate the average number of matches per tournament
    const tournamentCount = {{ tournaments|length }};
    const avgMatches = tournamentCount > 0 ? (totalMatches / tournamentCount).toFixed(1) : '0';
    document.getElementById('avgMatchesPerTournament').textContent = avgMatches;

    // Player chooses to jump
    document.getElementById('playerSelect').addEventListener('change', function() {
      const playerId = this.value;
      if (playerId) {
        window.location.href = `/analytics/player/${playerId}`;
      }
    });

    // Tournament Selection Jump
    document.getElementById('tournamentSelect').addEventListener('change', function() {
      const tournamentId = this.value;
      if (tournamentId) {
        window.location.href = `/analytics/tournament/${tournamentId}`;
      }
    });

    // Players are more controlled
    const player1Select = document.getElementById('player1Select');
    const player2Select = document.getElementById('player2Select');
    const compareBtn = document.getElementById('compareBtn');

    function updateCompareButton() {
      compareBtn.disabled = !(player1Select.value && player2Select.value && player1Select.value !== player2Select.value);
    }

    player1Select.addEventListener('change', updateCompareButton);
    player2Select.addEventListener('change', updateCompareButton);

    compareBtn.addEventListener('click', function() {
      if (player1Select.value && player2Select.value) {
        window.location.href = `/analytics/head_to_head?player1=${player1Select.value}&player2=${player2Select.value}`;
      }
    });
  });
</script>
{% endblock %}
