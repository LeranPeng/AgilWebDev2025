{% extends "layout.html" %}

{% block title %}Match Analysis - Badminton Manager{% endblock %}
{% block page_title %}Badminton MASTER{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<style>
  /* Share button dropdown styling */
  .share-dropdown {
    position: relative;
    display: inline-block;
  }
  
  .share-menu {
    display: none;
    position: absolute;
    right: 0;
    min-width: 200px;
    background-color: white;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-radius: 0.5rem;
    z-index: 10;
  }
  
  .share-menu.active {
    display: block;
  }
  
  .share-option {
    display: block;
    padding: 0.5rem 1rem;
    color: #374151;
    transition: background-color 0.2s;
  }
  
  .share-option:hover {
    background-color: #f3f4f6;
  }
  
  .copy-link-success {
    background-color: #d1fae5;
    color: #047857;
  }
</style>
{% endblock %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
  <div>
    <h2 class="text-2xl font-semibold">‚öîÔ∏è Matchup Analysis</h2>
    <p class="text-gray-600 mt-1">Compare the head-to-head records between two players</p>
  </div>
  <div class="flex space-x-2">
    <!-- Share Button -->
    <div class="share-dropdown">
      <button id="shareBtn" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 transition flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
          <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" />
        </svg>
        Share
      </button>
      <div id="shareMenu" class="share-menu">
        <button id="copyLinkBtn" class="share-option w-full text-left flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path d="M8 2a1 1 0 000 2h2a1 1 0 100-2H8z" />
            <path d="M3 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v6h-4.586l1.293-1.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L10.414 13H15v3a2 2 0 01-2 2H5a2 2 0 01-2-2V5zM15 11h2a1 1 0 110 2h-2v-2z" />
          </svg>
          Copy Link
        </button>
        <a id="emailShare" class="share-option flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
            <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
          </svg>
          Email
        </a>
        <a id="whatsappShare" class="share-option flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 448 512" fill="currentColor">
            <path d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4 0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3 0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.2 0-65.7-8.9-94-25.7l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2 0-101.7 82.8-184.5 184.6-184.5 49.3 0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5 0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8-3.7 5.6-14.3 18-17.6 21.8-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7.9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2-3.7 0-9.7 1.4-14.8 6.9-5.1 5.6-19.4 19-19.4 46.3 0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z" />
          </svg>
          WhatsApp
        </a>
        <a id="twitterShare" class="share-option flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
          </svg>
          X (Twitter)
        </a>
        <a id="facebookShare" class="share-option flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 320 512" fill="currentColor">
            <path d="M279.14 288l14.22-92.66h-88.91v-60.13c0-25.35 12.42-50.06 52.24-50.06h40.42V6.26S260.43 0 225.36 0c-73.22 0-121.08 44.38-121.08 124.72v70.62H22.89V288h81.39v224h100.17V288z" />
          </svg>
          Facebook
        </a>
      </div>
    </div>
    <a href="/analytics" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
      Back to Analytics
    </a>
  </div>
</div>

<!-- Player Select -->
<div class="bg-white rounded shadow p-6 mb-6">
  <form action="/analytics/head_to_head" method="GET" class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div>
      <label class="block font-medium mb-1">Player 1</label>
      <select name="player1" class="w-full border px-4 py-2 rounded" required>
        <option value="">Select Player...</option>
        {% for player in players %}
          <option value="{{ player.id }}" {% if player.id == player1_id %}selected{% endif %}>
            {{ player.name }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="block font-medium mb-1">Player 2</label>
      <select name="player2" class="w-full border px-4 py-2 rounded" required>
        <option value="">Select Player...</option>
        {% for player in players %}
          <option value="{{ player.id }}" {% if player.id == player2_id %}selected{% endif %}>
            {{ player.name }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="flex items-end">
      <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">
        Analyse the Matchup
      </button>
    </div>
  </form>
</div>

{% if head_to_head %}
  <!-- Matchup Overview -->
  <div class="bg-white rounded shadow p-6 mb-8">
    <h3 class="text-xl font-bold mb-6">ü•ä Head-to-head record</h3>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="col-span-1 bg-blue-50 p-4 rounded text-center">
        <h4 class="font-bold text-lg text-blue-800">{{ head_to_head.player1.name }}</h4>
        <p class="text-3xl font-bold mt-2 text-blue-700">{{ head_to_head.player1.wins }}</p>
        <p class="text-sm text-gray-600 mt-1">Wins</p>
        <a href="/analytics/player/{{ head_to_head.player1.id }}" class="text-blue-600 hover:underline mt-2 inline-block">
          View Player Stats
        </a>
      </div>

      <div class="md:col-span-1 flex items-center justify-center">
        <div class="text-center">
          <p class="text-lg font-bold">Total</p>
          <p class="text-4xl font-bold mt-1">{{ head_to_head.total_matches }}</p>
          <p class="text-sm text-gray-600 mt-1">Games</p>
        </div>
      </div>

      <div class="col-span-1 bg-red-50 p-4 rounded text-center">
        <h4 class="font-bold text-lg text-red-800">{{ head_to_head.player2.name }}</h4>
        <p class="text-3xl font-bold mt-2 text-red-700">{{ head_to_head.player2.wins }}</p>
        <p class="text-sm text-gray-600 mt-1">Wins</p>
        <a href="/analytics/player/{{ head_to_head.player2.id }}" class="text-red-600 hover:underline mt-2 inline-block">
          View Player Stats
        </a>
      </div>
    </div>

    <div class="mt-6">
      <canvas id="winRateChart" height="100"></canvas>
    </div>
  </div>

  <!-- Competition history -->
  <div class="bg-white rounded shadow p-6 mb-10">
    <h3 class="text-xl font-bold mb-4">üìú Match History</h3>
    {% if head_to_head.matches %}
      <div class="overflow-x-auto">
        <table class="min-w-full">
          <thead>
            <tr class="bg-gray-100 text-gray-600 text-sm leading-normal">
              <th class="py-3 px-4 text-left">Date</th>
              <th class="py-3 px-4 text-left">Tournament</th>
              <th class="py-3 px-4 text-left">Game Type</th>
              <th class="py-3 px-4 text-left">Team 1</th>
              <th class="py-3 px-4 text-left">Team 2</th>
              <th class="py-3 px-4 text-left">Score</th>
              <th class="py-3 px-4 text-left">Winner</th>
            </tr>
          </thead>
          <tbody class="text-gray-600">
            {% for match in head_to_head.matches %}
              <tr class="border-b hover:bg-gray-50">
                <td class="py-3 px-4">{{ match.date }}</td>
                <td class="py-3 px-4">{{ match.tournament }}</td>
                <td class="py-3 px-4">{{ match.match_type }}</td>
                <td class="py-3 px-4">{{ match.team1 }}</td>
                <td class="py-3 px-4">{{ match.team2 }}</td>
                <td class="py-3 px-4">{{ match.score1 }}</td>
                <td class="py-3 px-4">
                  {% if match.winner_id == head_to_head.player1.id %}
                    <span class="text-blue-600 font-medium">{{ head_to_head.player1.name }}</span>
                  {% else %}
                    <span class="text-red-600 font-medium">{{ head_to_head.player2.name }}</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-gray-600 text-center py-6">
        There is no record of matches between these two players.
      </p>
    {% endif %}
  </div>

  <!-- Quick Navigation Buttons -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
    <a href="/analytics" class="bg-blue-600 text-white p-4 rounded-lg shadow hover:bg-blue-700 transition text-center">
      Back to Analytics
    </a>
    <a href="/analytics/player/{{ head_to_head.player1.id }}" class="bg-indigo-600 text-white p-4 rounded-lg shadow hover:bg-indigo-700 transition text-center">
      View {{ head_to_head.player1.name }}'s Stats
    </a>
    <a href="/analytics/player/{{ head_to_head.player2.id }}" class="bg-purple-600 text-white p-4 rounded-lg shadow hover:bg-purple-700 transition text-center">
      View {{ head_to_head.player2.name }}'s Stats
    </a>
  </div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if head_to_head %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const winRateCtx = document.getElementById('winRateChart').getContext('2d');
      const player1Name = "{{ head_to_head.player1.name }}";
      const player2Name = "{{ head_to_head.player2.name }}";
      const player1Wins = {{ head_to_head.player1.wins }};
      const player2Wins = {{ head_to_head.player2.wins }};
      const totalMatches = {{ head_to_head.total_matches }};

      const player1WinRate = totalMatches > 0 ? (player1Wins / totalMatches * 100).toFixed(1) : 0;
      const player2WinRate = totalMatches > 0 ? (player2Wins / totalMatches * 100).toFixed(1) : 0;

      const winRateChart = new Chart(winRateCtx, {
        type: 'bar',
        data: {
          labels: ['Win Rate'],
          datasets: [
            {
              label: player1Name,
              data: [player1WinRate],
              backgroundColor: 'rgba(59, 130, 246, 0.7)',
              borderWidth: 0
            },
            {
              label: player2Name,
              data: [player2WinRate],
              backgroundColor: 'rgba(239, 68, 68, 0.7)',
              borderWidth: 0
            }
          ]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          }
        }
      });
      
      // Share functionality
      const shareBtn = document.getElementById('shareBtn');
      const shareMenu = document.getElementById('shareMenu');
      const copyLinkBtn = document.getElementById('copyLinkBtn');
      const twitterShare = document.getElementById('twitterShare');
      const emailShare = document.getElementById('emailShare');
      const whatsappShare = document.getElementById('whatsappShare');
      const facebookShare = document.getElementById('facebookShare');

      // Handle current URL for sharing
      const currentUrl = window.location.href;
      
      // Create share text
      const shareTitle = `Head-to-head: ${player1Name} vs ${player2Name}`;
      const shareText = `${player1Name} (${player1Wins}) vs ${player2Name} (${player2Wins}) - Check out their head-to-head record!`;
      
      // Toggle dropdown
      shareBtn.addEventListener('click', () => {
        shareMenu.classList.toggle('active');
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!shareBtn.contains(e.target) && !shareMenu.contains(e.target)) {
          shareMenu.classList.remove('active');
        }
      });
      
      // Copy link to clipboard
      copyLinkBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(currentUrl)
          .then(() => {
            copyLinkBtn.classList.add('copy-link-success');
            copyLinkBtn.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
              </svg>
              Link Copied!
            `;
            
            setTimeout(() => {
              copyLinkBtn.classList.remove('copy-link-success');
              copyLinkBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M8 2a1 1 0 000 2h2a1 1 0 100-2H8z" />
                  <path d="M3 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v6h-4.586l1.293-1.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L10.414 13H15v3a2 2 0 01-2 2H5a2 2 0 01-2-2V5zM15 11h2a1 1 0 110 2h-2v-2z" />
                </svg>
                Copy Link
              `;
            }, 2000);
          })
          .catch(err => {
            console.error('Could not copy link: ', err);
          });
      });
      
      // Set up social sharing links
      twitterShare.href = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(currentUrl)}`;
      emailShare.href = `mailto:?subject=${encodeURIComponent(shareTitle)}&body=${encodeURIComponent(shareText + '\n\n' + currentUrl)}`;
      whatsappShare.href = `https://wa.me/?text=${encodeURIComponent(shareText + ' ' + currentUrl)}`;
      facebookShare.href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(currentUrl)}&quote=${encodeURIComponent(shareText)}`;
    });
  </script>
{% endif %}
{% endblock %}